# 特征提取

## 11.1 基础知识

特征提取主要包括 2 部分：
- 特征检测
- 特征描述

一般来说，特征应独立于**位置**、**旋转**、**缩放**、**起点**，使用尽可能多的先验信息预处理图像可以提高特征提取的准确性

特征的**独立**分为以下 2 类：
- 不变：对于施加到目标上的一系列某些种类的变换，特征不发生改变
- 协变：对于施加到目标上的某些种类的任意变换，特征总是产生相同变化

> 例如，对椭圆施加 $[翻转，镜像，旋转]$ 变换，特征描述子*面积*不发生改变，因此面积对于这些种类的变换是一个不变的特征描述子。但若添加缩放操作，面积将不再是一个不变的特征描述子，而是一个协变的特征描述子，因为对椭圆缩放任意比例，面积总是发生相应比例的变化

特征可按区域分为以下 2 类：
- 局部
- 全局

> 某些特征描述子既可以是局部和也可以是全局的，例如*面积*

使用 $n$ 维特征向量描述的空间称为 *$n$ 维特征空间*

## 11.2 边界预处理

### 11.2.1 边界跟踪

**Moore 边界跟踪算法**使用二值图像，可以提取出宽度为 1 的顺时针或者逆时针边界点序列，算法如下（为了消除目标与边界重合的可能性，需要填充 0 值边框）
1. 以最左上的 1 值点为起点 $b_0$ 并记录位置，以其左侧邻点 $c_0$ 顺时针查找起点的 8 邻域，找到第一个值为 1 的邻点 $b_1$，查找序列的上一个点为 $c_1$。令 $b = b_1$，$c = c_1$
2. 从 $c$ 开始顺时针查找 $b$ 的 8 邻域，找到第一个 1 值点 $b_2$ 以及前一个点 $c_2$，令 $b = b_2$，$c = c_2$
3. 重复步骤 2 直至 $b = b_0$，算法停止时所有找到的 $b$ 点即为有序边界点序列。

> 最左上的 1 值点是边界多边形的一个凸顶点，且该位置的左邻点和上邻点保证是背景，因此该点是启动边界跟踪算法的好的标准点

### 11.2.2 链码

链码通过连接规定长度和方向的直线段来表示边界，本节假设所有曲线都是闭合而不自相交的

以下 2 种定义方法都是旋转独立的

#### 1. 弗里曼链码

基于 4 连通或 8 连通，将方向编号来表示链码，为了缩短链码长度、降低噪声和不完美分割的影响，通常会压缩图像分辨率以对边界重采样

链码可通过以下 2 种方式相对于起点归一化
1. 重新定义起点，使得得到的数字序列幅值最小
2. 使用链码的 1 阶差分代表链码本身

链码可通过图像重取样实现尺度归一化，仅当边界旋转不变且尺度变化时上述归一化才是精确到

#### 2. 斜率链码(SCC)

选取一个起点和线段长度，然后使用圆遍历将曲线替换为直线段序列，斜率链码由各直线段的斜率构成（斜率范围为 $(-1,1)$）

> 该方法不能保证链码曲线最后一点与曲线本身最后一点重合，但通常可通过缩短直线段长度、增大角度分辨率解决

### 11.2.3 用最小周长多边形(MPP)近似边界

#### 2. MPP 算法

> 包围数字边界的单元集合被称为*细胞复合体*

使用白色(W)表示凸顶点，蓝色(B)表示镜像凹顶点，MPP 有以下性质：
1. 由简单连通的细胞复合体包围的 MPP 不是自相交的
2. MPP 的所有凸顶点都是 W 顶点，但 W 顶点不一定是 MPP 的顶点
3. MPP 的所有凹顶点都是 B 顶点，但 B 顶点不一定是 MPP 的顶点
4. 所有 B 顶点都在 MPP 上或外部，所有 W 顶点都在 MPP 上或内部
5. 由细胞复合体包围的顶点序列中，最左上方的顶点总是 MPP 的一个 W 顶点

> MPP 顶点所维持的角度不一定是 $\frac{\pi}{2}$ 的倍数

以三元点 $(a,b,c)$ 定义如下矩阵
$$
\tag{11.1} \boldsymbol{A} = \begin{bmatrix}
    a_x & a_y & 1 \\
    b_x & b_y & 1 \\
    c_x & c_y & 1 \\
\end{bmatrix}
$$
则有
$$
\tag{11.2} \mathrm{det}(\boldsymbol{A})  \begin{cases}
    > 0, \quad (a,b,c) 是逆时针序列 \\
    = 0, \quad (a,b,c) 是共线的 \\
    < 0, \quad (a,b,c) 是顺时针序列 \\
\end{cases}
$$
描述算法时常方便地定义
$$
\tag{11.3} \mathrm{sgn}(a,b,c) = \mathrm{det}(\boldsymbol{A})
$$
从而当 $\mathrm{sgn}(a,b,c) > 0$ 时 $c$ 位于点对 $(a,b)$  正侧，反之位于负侧

MPP 预处理需形成以下内容：一个由点标记（$V_0$、$V_1$等）组成的 3 顶点列表；每个点的坐标；表示顶点类型（W 或 B）的额外元素。顶点需排序且第一个顶点 $V_0$ 在最左上方，由性质 5 可知它是 W 顶点。MPP 算法使用 2 个爬行点：白色爬行点 $W_C$ 沿 W 顶点爬行，蓝色爬行点 $B_C$ 沿 B 顶点爬行

算法从 $W_C = B_C = V_0$ 开始，迭代至找到的新顶点为 $V_0$，令 $V_L$ 为找到的最后一个顶点，$V_k$ 为当前正在检查的顶点，则
1. 若 $V_k$ 在 $(V_L,W_C)$ 正侧，则下一个顶点是 $W_C$，令 $V_L = B_C = W_C$ 初始化算法，从 $V_L$ 的下一个顶点继续算法
2. 若 $V_k$ 在 $(V_L,B_C)$ 负侧，则下一个顶点是 $B_C$，令 $V_L = W_C = B_C$ 初始化算法，从 $V_L$ 的下一个顶点继续算法
3. 若 $V_k$ 在 $(V_L,W_C)$ 负侧或与其共线，且$V_k$ 在 $(V_L,B_C)$ 正侧或与其共线，则下一个顶点是 $V_k$。此时
    1. 若 $V_k$ 是凸顶点，则令 $W_C = V_k$
    2. 若 $V_k$ 是凹顶点，则令 $B_C = V_k$

   然后从 $V_L$ 的下一个顶点继续算法

### 11.2.4 标记图

是二维边界的一维表示，通常使用角度作横坐标，使用距离或者相对斜率作纵坐标

### 11.2.5 骨架、中轴与距离变换

骨架可通过拓扑保持细化或者中轴变换(MAT)得到，MAT 更容易产生有意义的骨架，可通过距离变换（时间复杂度为 $\mathrm{O}(N)$ 且可并行执行）高效地得到其等效骨架

对于二值图像，其距离变换是每个像素到距离其最近的前景像素的距离，其骨架是距离变换的脊（局部极大值集合）

## 11.3 边界特征描述子

### 11.3.1 一些基本的边界描述子

- 长度
- 直径
- 长轴（最长弦）
- 短轴（最长垂直弦）
- 基本矩形（外接矩形、外接盒）
- 偏心率
- 曲折度（曲率）

### 11.3.2 形状数

形状数是 4 方向链码最小幅度的一阶差分，其阶数 $n$ 是其中数字的数量

归一化网格方向：对于 $n$ 阶形状数的形状，定义相同阶数的矩形，使得该矩形的偏心率最接近基本矩形的偏心率，且两边分别与基本矩形平行。利用该矩形建立网格，得到弗里曼编码，计算形状数，如果与阶数相同则停止迭代，否则使用阶数更小的矩形重复这个过程直至得到相同的阶数。

### 11.3.3 傅里叶描述子

对于 $K$ 个点 $(x_n, y_n)$ 组成的数字边界，令 $x(k) = x_k$、$y(k) = y_k$、$s(k) = [x(k), y(k)]$，将点对视为复数，则
$$
\tag{11.7} s(k) = x(k) + i y(k)
$$
则 $s(k)$ 的离散傅里叶变换为
$$
\tag{11.8} a(u) = \sum_{k=0}^{K-1} s(k) \mathrm{e}^{-j 2 \pi u k / K} \quad  u = 0,1,2,...,K-1
$$
$a(u)$ 是边界的*傅里叶描述子*，可通过下式得到原输入
$$
\tag{11.9} s(k) = \frac{1}{K} \sum_{u=0}^{K-1} a(u) \mathrm{e}^{j 2 \pi u k / K}
$$
若只使用前 $P$ 个系数，即 $u \geqslant P$ 时令 $a(u) = 0$，则 $s(k)$ 有如下近似：
$$
\tag{11.10} \hat{s}(k) = \frac{1}{K} \sum_{u=0}^{P-1} a(u) \mathrm{e}^{j 2 \pi u k / K}\quad  k = 0,1,2,...,K-1
$$
$P$ 越大则保留的细节越多

| 变换 | 边界 | 傅里叶描述子 |
| ---- | ---- | ---- |
| 恒等 | $s(k)$ | $a(u)$ |
| 旋转 | $s_r(k) = s(k)e^{j\theta}$ | $a_r(u) = a(u)e^{j\theta}$ |
| 平移 | $s_t(k) = s(k) + \Delta_{xy}$ | $a_r{u} = a(u) + \Delta_{xy} \delta (u)$ |
| 缩放 | $s_s(k) = \alpha s(k)$ | $a_s(u) = \alpha a(u)$ |
| 起点 | $s_p(k) = s(k-k_0)$ | $a_p(u) = a(u) \mathrm{e}^{-j 2 \pi k_0 u / K}$ |

### 11.3.4 统计矩

可用来表征标记图，优点是实现简单，且带有标记图及边界形状的物理解释，对旋转不敏感

> 除了统计矩，也可用 $g(r)$ 的离散傅里叶变换频谱的前几个分量作为描述子

将标记图视为离散函数 $g(r)$，则 $z = g(r)$ 的 $n$ 阶矩为
$$
\tag{11.14} \mu_n(z) = \sum_{i=0}^{A-1} (z_i - \bar{z})^n p(z_i)
$$
显然 $\mu_0 = 1$，$\mu_1 = 0$，$\mu_2$ 是方差

也可将 $g(r)$  面积归一化并将其视为直方图，得到
$$
\tag{11.16} \mu_n(r) = \sum_{i=0}^{K-1} (r_i - \bar{r})^n g(r_i)
$$
其中二阶矩度量曲线相对于 $r$ 的平均值的扩展度，三阶矩度量曲线相对于 $r$  平均值的对称性

## 11.4 区域特征描述子

### 11.4.1 一些基本的描述子

- 面积 $A$，通常将其归一化用于计算下列特征
- 周长 $p$
- 紧致度 $\frac{p^2}{A}$，圆拥有最小的紧致度 $4 \pi$
    > 有时也将紧致度定义为圆度的倒数，得到的值为上述定义的 $\frac{1}{4 \pi}$
- 圆度 $\frac{4 \pi A}{p^2}$
- 有效直径 $d_e = 2 \sqrt{\frac{A}{\pi}}$，可将其除以最大直径进行归一化
- 偏心率，定义为与区域有相同二阶中心矩且轴与数据主轴重合的椭圆的偏心率 $\frac{c}{a}$，值为 
   $$
   \tag{11.23} 偏心率 = \sqrt{1 - (\frac{\lambda_2}{\lambda_1})^2} \quad \lambda_1 \geqslant \lambda_2
   $$

### 11.4.2 拓扑描述子

拓扑性质不依赖于基于距离测度的任何性质

可以用区域中的孔洞数 $H$ 和连通分量数 $C$ 定义欧拉数
$$
\tag{11.24} E = C - H
$$

定义顶点数 $V$，边数 $Q$，面数 $F$，则欧拉公式的表达式为
$$
\tag{11.25} V - Q + F = C - H = E
$$

### 11.4.3 纹理

虽然不存在正式定义，但纹理直观上提供了平滑度、粗糙度、规则性等特性的测度，本节主要讨论以下 2 种描述方法
1. 统计方法，产生光滑、粗糙、颗粒等纹理特征
2. 谱方法，基于傅里叶频谱的性质，主要通过识别频谱中的高能量窄峰来检测图像中的全局周期性

#### 1. 统计方法

最简单方法之一是使用灰度直方图的统计矩，其中二阶矩 $\mu_2$ 在纹理描述中尤其重要，它是对比度的一个测度，将其归一化为 $\mu_2^*$ 后，可定义如下平滑度
$$
\tag{11.29} R(z) = 1 - \frac{1}{1 + \mu_2^*(z)}
$$

三阶矩是直方图偏斜度的一个测度，四阶矩是相对平坦度的一个测度，更高阶的矩很难与直方图的形状关联起来，但能够进一步定量描述纹理内容

一致性测度定义为
$$
\tag{11.30} U(z) = \sum_{i=0}^{L-1}p^2(z_i)
$$

平均熵定义为
$$
\tag{11.31} e(z) = - \sum_{i=0}^{L-1} p(z_i) \log_2 p(z_i)
$$

> 上述测度只使用了直方图，不包含像素间的空间关系信息

定义某个相对位置条件 $Q$，对于含有 $L$ 个灰度级的图像 $f$，$g_{ij}$ 是灰度为 $z_i$、$z_j$ 的由 $Q$ 定义的像素对的数量，其形成的矩阵 $\boldsymbol{G}$ 为*灰度共生矩阵*，简称**共生矩阵**

> 实际实践中常压缩灰阶数以缩小共生矩阵的规模

$K \times K$ 阶共生矩阵可用如下描述子表征，其中相邻的定义是满足条件 $Q$

| 描述子 | 解释 | 公式 |
| ---- | ---- | ---- |
| 最大概率 | $\boldsymbol{G}$ 的最强响应，值域是 $[0,1]$ | $\max p_{ij}$ |
| 相关 | 像素与其相邻像素的相关度，值域为 $[-1,1]$，标准差为 $0$ 时无定义 | $\sum_{i=1}^K \sum_{j=1}^K \frac{(i-m_r)(j-m_c) p_{ij}}{\sigma_r \sigma_c}$ |
| 对比度 | 像素与其相邻像素之间的对比度测度，值域为 $[0,(K-1)^2]$ | $\sum_{i=1}^K \sum_{j=1}^K (i-j)^2 p_{ij}$ |
| 均匀性（能量） | 均匀性的测度，值域为 $(0,1]$ |  $\sum_{i=1}^K \sum_{j=1}^K p_{ij}^2$ |
| 同质性 | $\boldsymbol{G}$ 中对角分布的元素的空间接近度测度，值域为 $(0,1]$，$\boldsymbol{G}$ 为对角矩阵时值为 $1$ | $\sum_{i=1}^K \sum_{j=1}^K \frac{p_{ij}}{1 + \| i-j \|}$ |
| 熵 | $\boldsymbol{G}$ 中元素的随机性的测度，值域为 $(0, 2 \log_2 K]$ | $-\sum_{i=1}^K \sum_{j=1}^K p_{ij} \log_2 p_{ij}$ |

> 可通过调整 $Q$ 中定义的间隔距离求出不同的相关并作图，寻找图像中的重复模式

#### 2. 谱方法

傅里叶谱非常适合描述图像中周期或半周期二维模式的方向性，其有以下 3 个特征
1. 谱中的突出峰给出纹理模式的主方向
2. 频率平面上的峰值位置给出纹理模式的基本空间周期
3. 可通过滤波消除任何周期分量，然后利用统计技术描述留下的非周期图像元素

谱相对于原点是对称的，为了简化分析，只考虑频率平面的一半，每个周期模式只与谱中的 1 个峰相关联，可通过极坐标化为 $S(r,\theta)$ 简化分析

### 11.4.4 矩不变量

尺寸为 $M \times N$ 的数字图像 $f(x,y)$ 的二维 $(p+q)$ 阶矩定义为
$$
\tag{11.34} m_{pq} = \sum_{x=0}^{M-1} \sum_{y=0}^{N-1} x^p y^q f(x,y)
$$
令 $\bar{x} = \frac{m_{10}}{m_{00}}$，$\bar{y} = \frac{m_{01}}{m_{00}}$，中心矩定义为
$$
\tag{11.35} \mu_{pq} = \sum_{x=0}^{M-1} \sum_{y=0}^{N-1} (x - \bar{x})^p (y - \bar{y})^q f(x,y)
$$
令 $\gamma = \frac{p+q}{2} + 1$，归一化中心矩定义为
$$
\tag{11.37} \eta_{pq} = \frac{\mu_{pq}}{\mu_{00}^{\gamma}}
$$

由二阶和三阶归一化中心矩可推导出 1 组 7 个二维矩不变量：
$$
\tag{11.39-45} \begin{aligned}
    \phi_1 &= \eta_{20} + \eta_{02} \\
    \phi_2 &= (\eta_{20} - \eta_{02})^2 + 4 \eta_{11}^2 \\
    \phi_3 &= (\eta_{30} - 3 \eta_{12})^2 + (\eta_{03} - 3 \eta_{21})^2 \\
    \phi_4 &= (\eta_{30} - \eta_{12})^2 + (\eta_{03} - \eta_{21})^2 \\
    \phi_5 &= (\eta_{30} - 3 \eta_{12})(\eta_{30} + \eta_{12})[(\eta_{30} + \eta_{12})^2 - 3(\eta_{03} + \eta_{21})^2] + (\eta_{03} - 3 \eta_{21})(\eta_{03} + \eta_{21})[(\eta_{03} + \eta_{21})^2 - 3(\eta_{30} + \eta_{12})^2] \\
    \phi_6 &= (\eta_{20} - \eta_{02})[(\eta_{30} + \eta_{12})^2 - (\eta_{03} + \eta_{21})^2] + 4 \eta_{11}(\eta_{30} + \eta_{12})(\eta_{03} + \eta_{21}) \\
    \phi_7 &= (3 \eta_{21} - \eta_{03})(\eta_{30} + \eta_{12})[(\eta_{30} + \eta_{12})^2 - 3(\eta_{03} + \eta_{21})^2] - (3 \eta_{12} - \eta_{30})(\eta_{03} + \eta_{21})[(\eta_{03} + \eta_{21})^2 - 3(\eta_{30} + \eta_{12})^2] \\
\end{aligned}
$$
这组矩的值对平移、旋转、缩放、镜像是不变的，$\phi_7$ 的符号会随镜像改变

## 11.5 将主分量用做特征描述子

本节内容适用于图像序列（或多通道图像），将 $n$ 幅配准后的图像视为一个整体，则某位置的所有像素可视为一个 $n$ 维向量：
$$
\tag{11.46} \boldsymbol{x} = \begin{bmatrix}
    x_1 \\ x_2 \\ \vdots \\ x_n
\end{bmatrix}
$$

总体平均向量定义为
$$
\tag{11.47} \boldsymbol{m_x} = E\{\boldsymbol{x}\}
$$
$E\{\boldsymbol{x}\}$ 为 $\boldsymbol{x}$ 的期望值

总体协方差矩阵定义为
$$
\tag{11.48} \def\cov{(\boldsymbol{x} - \boldsymbol{m_x})} \boldsymbol{C_x} = E\{ \cov \cov^{\mathrm{T}} \}
$$
其是实对称矩阵，因此存在一组 $n$ 个正交的特征向量

令 $\boldsymbol{e}_i$、$\boldsymbol{\lambda}_i$ 为 $\boldsymbol{C_x}$ 的特征向量、特征值，令 $\boldsymbol{A}$ 为由 $\boldsymbol{e}_i$ 按 $\boldsymbol{\lambda}_i$ 降序排列构成的矩阵，，则*霍特林变换*（也称为离散 Karhunen-Loève 变换、主分量变换）定义为
$$
\tag{11.49} \boldsymbol{y} = \boldsymbol{A}(\boldsymbol{x} - \boldsymbol{m_x})
$$
其满足
$$
\tag{11.50} \boldsymbol{m_y} = E\{ \boldsymbol{y} \} = \boldsymbol{0}
$$
其协方差矩阵为
$$
\tag{11.51-52} \boldsymbol{C_y} = \boldsymbol{A C_x A}^{\mathrm{T}} = \begin{bmatrix}
    \lambda_1 & & & 0 \\
    & \lambda_2 & & \\
    & & \ddots & \\
    0 & & & \lambda_n \\
\end{bmatrix}
$$
该矩阵为对角矩阵，因此 $\boldsymbol{y}$ 的元素是不相关的

$\boldsymbol{x}$ 可由 $\boldsymbol{y}$ 重建
$$
\tag{11.53} \boldsymbol{x} = \boldsymbol{A}^{\mathrm{T}} \boldsymbol{y} + \boldsymbol{m_x}
$$
也可仅使用由前 $k$ 个特征向量组成的变换矩阵 $\boldsymbol{A}_k$ 近似重建：
$$
\tag{11.54} \hat{\boldsymbol{x}} = \boldsymbol{A}_k^{\mathrm{T}} \boldsymbol{y} + \boldsymbol{m_x}
$$
其与 $\boldsymbol{x}$ 的均方差为
$$
\tag{11.55} e_{ms} = \sum_{j=1}^n \lambda_j - \sum_{j=1}^k \lambda_j = \sum_{j=k+1}^n \lambda_j
$$

将图像中的点坐标视为二维列向量，其主分量可用来进行平移、旋转归一化，其特征值可用来进行尺度归一化

## 11.6 整体图像特征

### 11.6.1 哈里斯-斯蒂芬斯角检测器

定义某块图像 $f(s,t)$，其移动 $(x,y)$ 后为 $f(s+x,t+y)$，则使用权重函数 $w(s,t)$ 的加权平均和为
$$
\tag{11.56} C(x,y) = \sum_s \sum_t w(s,t) [f(s+x,t+y) - f(s,t)]^2
$$
令 $f_x(s,t) = \partial f / \partial x$，$f_y(s,t) = \partial f / \partial y$，移动后的小块图像可用泰勒级数展开近似：
$$
\tag{11.57} f(s+x,t+y) = f(s+t) + x f_x(s,t) + y f_y(s,t)
$$
从而 $11.56$ 可写为
$$
\tag{11.58-59} C(x,y) = \sum_s \sum_t w(s,t)[x f_x(s,t) + y f_y(s,t)]^2 = [x,y] \boldsymbol{M} \begin{bmatrix}
    x \\ y
\end{bmatrix}
$$
$$
\tag{11.60} \boldsymbol{M} = \sum_s \sum_t w(s,t) \begin{bmatrix}
    f_x^2 & f_x f_y \\
    f_x f_y & f_y^2 \\
\end{bmatrix}
$$
$\boldsymbol{M}$ 称为哈里斯矩阵，若 $w(s,t)$ 是各向同性的，则 $\boldsymbol{M}$ 是对称的

> 通常使用盒式核和高斯核作为 $w(s,t)$

> 对 $(f_x, f_y)$ 做散点图，并求 $\boldsymbol{M}$ 的特征值
> - 灰度平坦的区域会形成一个较小的圆形簇，有 2 个较小特征值
> - 边缘会在某一方向上产生离群值，有一大一小特征值
> - 角或孤立点会在两个方向上产生离群值，有 2 个较大特征值

HS 检测器使用角响应测度免去了计算特征值的开销，其对旋转不敏感，定义如下
$$
\tag{11.63} R = \lambda_X \lambda_y - k (\lambda_x + \lambda_y)^2 = det(\boldsymbol{M}) - k \mathrm{tr}^2(\boldsymbol{M})
$$
$\mathrm{tr}(\boldsymbol{M})$ 是 $\boldsymbol{M}$ 的迹，$k$ 是根据经验确定的常数，一般取 $0 < k < 0.25$，特征值均较大时 $R$ 具有较大正值，特征值一大一小时 $R$ 具有较大负值，特征值均较小时 $R$ 具有较小绝对值

### 11.6.2 最大稳定极值区域(MSER)

可用来检测暗背景下的明亮区域（可通过反相来检测亮背景下的昏暗区域），是仿射协变的

以 8-bit 灰度图为例，对所有灰度级依次进行阈值处理，其对应的连通分量形成极值区域集合，在阈值范围内不改变大小的极值区域称为*最大稳定极值区域*

> 上述过程用文字描述很难清晰描述，建议结合书上的图 11.51 进行理解

上述过程可转换为被称为*分量树*的有根连通树，其每一级对应一个阈值，每个节点表示一个如下定义的极值区域 $R$：
$$
\tag{11.64} \forall p \in R 和 \forall q \in \mathrm{boundary} R : I(p) > I(q)
$$
$I$ 为当前图像，$p$、$q$ 是像素点，上式表示极值区域内任意一点的灰度均高于边界上任意一点的灰度

定义稳定性测度
$$
\tag{11.65} \varPsi(R_j^{T + n \Delta T}) = \frac{|R_i^{T + (n-1) \Delta T}| - |R_k^{T + (n+1) \Delta T}|}{|R_j^{T + n \Delta T}|}
$$
$|R|$ 为连通区域 $R$ 的面积（像素数量），$T \in [\min(I),\max(I)]$，$\Delta T$ 为人为规定的阈值增量

## 11.7 尺度不变特征变换(SIFT)

SIFT 会将图像数据变换为相对于局部图像特征的尺度不变坐标，可用于提取图像中的不变特性，具有很强的探索性

SIFT 特征（称为*关键点*）对图像尺度和旋转是不变的，对仿射变换、三维视点变换、噪声、光照变化具有很强的鲁棒性

SIFT 的输入是一幅归一化图像，输出是由不变的特征描述子构成的 $n$ 维特征向量

算法如下：
1. 对于输入图像 $f$，选择标准差 $\sigma$，用高斯核 $G$ 构建尺度空间
    $$
    \tag{11.66} L(x,y,\sigma) = G(x,y,\sigma) \star f(x,y)
    $$

    将尺度空间细分为倍频程，每经过一个倍频程初始图像宽高减半，初始标准差加倍，选择一个区间数 $s$，则每个倍频程下有 $s+1$ 张图像，它们分别是初始图像使用标准差为 $2^{i/s} \sigma, i=0,1,...,s$ 的高斯核平滑处理得到的

    该步骤实现了尺度不变性

    > 一般使用 $\sigma = 1.6$，$s = 2$，倍频程数量 $n = 3$

2. 计算高斯差分
    $$
    \tag{11.68-69} D(x,y,\sigma,i) = [G(x,y,2^{i+1/s} \sigma) - G(x,y,2^{i/s} \sigma)] \star f(x,y) = L(x,y,2^{i+1/s} \sigma) - L(x,y,2^{i/s} \sigma), \quad i = 1,2,...,s-1
    $$
    寻找其极值，该极值的值大于其 8 个相邻像素以及同一倍频程中前后 2 张图像对应位置上的邻域内的 18 个像素的值，将这些极值点作为初始关键点

3. 使用如下海森矩阵 $\boldsymbol{H}$
    $$
    \tag{11.73} \def\pD{\partial^2 D} \boldsymbol{H} = \begin{bmatrix}
        \pD / \partial x^2 & \pD / \partial x \partial y & \pD / \partial x \partial \sigma \\
        \pD / \partial y \partial x & \pD / \partial y^2 & \pD / \partial y \partial \sigma \\
        \pD / \partial \sigma \partial x & \pD / \partial \sigma \partial y & \pD \partial / \sigma^2 \\
    \end{bmatrix}
    $$
    $\nabla D$ 为 $D$ 相对于偏移量 $\boldsymbol{x} = (x,y,\sigma)^{\mathrm{T}}$ 的梯度，，则极值位置为
    $$
    \tag{11.74} \hat{\boldsymbol{x}} = - \boldsymbol{H}^{-1}(\nabla D)
    $$
    若偏移量 $\hat{\boldsymbol{x}}$ 在所有维度上都大于 $0.5$，则极值更靠近其他样本点，此时应使用该偏移量改变样本点并进行内插

4. 计算极值位置函数
    $$
    \tag{11.75} D(\hat{\boldsymbol{x}}) = D + \frac{1}{2}(\nabla D)^{\mathrm{T}} \hat{\boldsymbol{x}}
    $$
    剔除所有值小于阈值的关键点，这些点是具有低对比度的不稳定极值

    > 一般使用 $0.03$ 作为阈值

5. 使用如下海森矩阵定义高斯差分的局部曲折度，其特征值与 $D$ 的曲折度成正比
    $$
    \tag{11.76} \def\pD{\partial^2 D} \boldsymbol{H} = \begin{bmatrix}
        \pD / \partial x^2 & \pD / \partial x \partial y \\
        \pD / \partial y \partial x & \pD / \partial y^2 \\
    \end{bmatrix} = \begin{bmatrix}
        D_{xx} & D_{xy} \\ D_{yx} & D_{yy}
    \end{bmatrix}
    $$

    令 $\alpha$ 为最大特征值，$\beta$ 为最小特征值，则
    $$
    \tag{11.77} \begin{aligned}
        \mathrm{tr}(\boldsymbol{H}) &= D_{xx} + D_{yy} = \alpha + \beta \\
        \mathrm{det}(\boldsymbol{H}) &= D_{xx} D_{yy} - (D_{xy})^2 = \alpha \beta \\
    \end{aligned}
    $$
    丢弃行列式为负值的特征点，这些点的曲折度具有不同的符号

    令 $r = \alpha / \beta$，则
    $$
    \tag{11.78} \frac{[\mathrm{tr}(\boldsymbol{H})]^2}{\mathrm{det}(\boldsymbol{H})} = \frac{(r+1)^2}{r}
    $$
    选取一个阈值，剔除上式的值大于阈值的关键点

    > 一般剔除 $r > 10$ 的关键点，此时 $T = 12.1$

6. 使用最接近关键点的尺度，计算对应的高斯平滑图像 $L$ 中关键点邻域的梯度的幅度 $M$ 和方向 $\theta$：
    $$
    \tag{11.80} M(x,y) = \sqrt{L(x+1, y) - (L(x-1, y))^2 + (L(x, y+1) - L(x, y-1))^2}
    $$
    $$
    \tag{11.81} \theta(x,y) = \arctan \frac{L(x, y+1) - L(x, y -1)}{L(x+1, y) - L(x-1, y)}
    $$

    $\sigma$ 为该尺度下的标准差，用 $1.5\sigma$ 标准差的高斯函数加权计算 36 阶方向梯度直方图(Historgram of Oriented Gradients, HOG)，依次使用所有幅度大于 80% 最大幅度的局部峰值创建关键点，这些关键点具有相同的位置、尺度和不同的方向

    最后，使用抛物线对峰及其两侧的共计 3 个值进行拟合，求出精确的峰值方向

    该步骤实现了旋转不变性

    > 通常使用边长为 16 像素的邻域

7. 将邻域进一步细分为子区域，计算子区域的梯度，其中方向使用关键点的方向进行归一化，计算子区域的 HOG，得到特征向量

    > 对于边长为 16 的邻域，通常将其分割为 16 个 $4 \times 4$ 子区域，计算 8 阶 HOG，从而得到 $16 \times 8 = 128$ 维特征向量

    之后将特征向量除以其范数进行归一化，剔除其中大于阈值的值，使用特征向量中未被剔除的对应值重新计算范数并进行归一化，得到归一化特征向量

    > 一般使用 0.2 作为特征向量归一化时使用的阈值

之后，可以分别计算多张图像的关键点以及特征向量，通过计算特征向量的距离来寻找匹配的关键点，这些匹配可用来表征图像中相同的部分（例如，某块子区域位于图像中的什么位置）

> 噪声等因素会导致与某特征向量第二接近的特征向量与最接近的特征向量计算得出的距离相近，通过舍弃距离比大于阈值的匹配，可以在几乎不损失正确匹配的情况下剔除大多数错误匹配，这个阈值一般选用 0.8

> 尽管 SIFT 对光照具有一定的鲁棒性，但对图像预处理增强对比度可提高性能
